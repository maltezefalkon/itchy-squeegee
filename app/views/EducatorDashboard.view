<!DOCTYPE html>
<html lang="en">
<head>
    <title><%=pageTitle%></title>
	<%=headerTags%>
	<link rel="stylesheet" href="/client/lib/jquery-ui-1.11.4.custom/jquery-ui.css"/>
    <style type="text/css">
	button.doc-command {
		width: 100px
	}

	.status {
		white-space: nowrap;
	}
    </style>
	<script type="text/javascript">
	function generateEmployeeInvitation() {
		$.ajax({
			
			success: function(returnedData) {
				employeeLink = returnedData.Url;
				$('#employeeLink').attr('href', employeeLink);
				$('#employeeCopyLinkButton').attr('data-clipboard-text', employeeLink);
				$('#employeeLink').text(employeeLink);
				$('#employeeSuccessDialog').modal('show');
			}
		});
	}
	function doSubmission(documentInstanceID, tenureID) {
		var apiUrl = '<%=createUrl('ApiCommand', [ 'SubmitDocument' ])%>?documentInstanceID=' + encodeURIComponent(documentInstanceID) + '&tenureID=' + encodeURIComponent(tenureID);
		$.ajax({
			url: apiUrl,
			cache: false,
			type: 'POST',
			success: function(data) {
				document.location.reload(true);
			},
			error: function(jqXHR) {
				alert('Error: ' + jqXHR);
			}
		});
	}

	$(function () {
		$('[data-toggle="popover"]').popover({ trigger: 'hover' });
	})
	</script>
</head>
<body ng-app="safeApp" ng-controller="controller">
    <%=advancedAngularTags%>
    <script type="text/javascript">
        var app = angular.module('safeApp', [ 'ngMessages', 'ui.mask', 'ui.date', 'ui.validate' ]);
        var ctl = app.controller('controller', EducatorDashboardController);
        ctl.$inject = ['$scope', '$http', '$location' ];
    </script>
	<script type="text/javascript" src="/client/util/angular-directives.js"></script>
    <div class="container">
		<%=uploadFunctionality%>
        <%=pageHeader%>
        <div class="page-header">
            <span class="h2">
                <%=pageTitle%>
            </span>
            <div class="pull-right">
                <button class="btn btn-primary" type="button" onclick="document.location.href = '<%=createUrl('EducatorDocuments')%>'">
                    Manage Documents
                </button>
            </div>
        </div>
<% for (var i in displayTenures) { %>
        <div class="panel panel-default">
            <div class="panel-heading">
				<span><%=isTenureApplication(displayTenures[i]) ? 'Application' : 'Required'%> Clearances for <%=displayTenures[i].Organization.Name%></span>
            </div>
            <div class="panel-body">
                <table width="100%" class="table">
                    <thead>
                        <tr>
							<th class="col-xs-1">Action</th>
                            <th class="col-xs-7">Document</th>
                            <th class="col-xs-1 text-center">Status</th>
                            <th class="col-xs-1 text-center">Date Submitted</th>
                            <th class="col-xs-1 text-center">Date Approved</th>
                            <th class="col-xs-1 text-center">Next Renewal</th>
                        </tr>
                    </thead>
                    <tbody>
<% 
var filteredDescriptors = _.filter(requiredDocumentDescriptors, function(desc) { return desc.ApplicableTenureID == displayTenures[i].TenureID || !desc.ApplicableTenureID; });
for (var j in filteredDescriptors) {
	var desc = filteredDescriptors[j];
	var def = desc.DocumentDefinition;
	var sub = _.find(displayTenures[i].Submissions, function(submission) {
		var thisDoc = _.find(educator.Documents, function(edoc) {
			return edoc.DocumentInstanceID == submission.DocumentInstanceID;
		});
		return thisDoc.DocumentDefinitionID == def.DocumentDefinitionID 
			&& (!desc.ApplicableTenure || thisDoc.ApplicableTenureID == desc.ApplicableTenure.TenureID); });
	var name = desc.Name;
	var doc = _.find(desc.Documents, function(document) {
		return !desc.ApplicableTenureID || desc.ApplicableTenureID == displayTenures[i].TenureID;
	});
%>
						<tr>
							<td>
								<div class="dropdown">
									<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
										<span class="glyphicon glyphicon-cog"></span>
										<span class="caret"></span></button>
									</button>
									<ul class="dropdown-menu">
<% if (doc && !sub) { %>
										<li>
											<a href="#" onclick="doSubmission('<%=doc.DocumentInstanceID%>', '<%=displayTenures[i].TenureID%>')">
												<span class="glyphicon glyphicon-send"></span> <%=sub ? 'Resubmit' : 'Submit'%> Document
											</a>
										</li>
<% } %>
<% if (!doc && !def.IsUpload) { %>
										<li>
											<a href="<%=createUrl('CreateForm', createFormUrlParameters)%>">
												<span class="glyphicon glyphicon-star"></span> Create
											</a>
										</li>
<% } %>
<% if (doc) { %>
										<li>
											<a href="#" onclick="window.open('<%=createUrl('DownloadForm', [doc.DocumentInstanceID])%>')">
												<span class="glyphicon glyphicon-save"></span> Download Document
											</a>
										</li>
<% } %>
<% if (def.IsUpload) { %>
	<% if ((doc && !sub) || (!def.IsUpload)) { %>
										<li class="divider"></li>
    <% } %>
										<li>
											<a href="#" onclick="showUploadDialog('<%=def.Name%>','<%=def.DocumentDefinitionID%>',<%=desc.ApplicableTenure ? '\'' + desc.ApplicableTenure.TenureID + '\'' : 'null'%>, <%=desc.ReferenceTenure ? '\'' + desc.ReferenceTenure.TenureID + '\'' : 'null'%>)">
												<span class="glyphicon glyphicon-cloud-upload"></span> Upload<%=(doc ? ' Updated ' : ' ')%> Document
											</a>
										</li>
<% } %>
<% if (def.ExternalUrl) { %>
										<li class="divider"></li>
										<li>
											<a target="_blank" href="<%=def.ExternalUrl%>">
												<span class="glyphicon glyphicon-link"></span> Open Website
											</a>
										</li>
<% } %>
									</ul>
								</div>
							</td>
							<td><%=name%></td>
							<td class="text-center"><%=getSubmissionStatusMarkup(sub, doc)%></td>
							<td class="text-center"><%=sub ? formatDate(sub.SubmissionDate) : null%></td>
							<td class="text-center"><%=sub ? formatDate(sub.ApprovalDate) : null%></td>
							<td class="text-center"><%=sub ? formatDate(sub.RenewalDate) : null%></td>
						</tr>
<% 
}
%>
                    </tbody>
                </table>
            </div>
        </div>
<% } %>
	    <%=pageFooter%>
    </div>
</body>
</html>
